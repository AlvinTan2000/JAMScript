<!DOCTYPE html>
<html lang="en">
  <!-- Beautiful Jekyll | MIT license | Copyright Dean Attali 2016 -->
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Data Persistence</title>

  <meta name="author" content="Robert Wenger" />
  
  
  <meta name="description" content="Logging and Broadcasting Data in JAMScript">
  

  <link rel="alternate" type="application/rss+xml" title="JAMScript - A Language and Middleware for Cloud of Moving Things" href="/JAMScript-beta/feed.xml" />

  
    
      <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.0/css/font-awesome.min.css" />
    
      
  
  
    
      <link rel="stylesheet" href="/JAMScript-beta/css/bootstrap.min.css" />
    
      <link rel="stylesheet" href="/JAMScript-beta/css/bootstrap-social.css" />
    
      <link rel="stylesheet" href="/JAMScript-beta/css/main.css" />
    
    
  
  
    
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
    
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
    
  

    
  
  

  

  <!-- Facebook OpenGraph tags -->
  <meta property="og:title" content="Data Persistence" />
  <meta property="og:type" content="website" />
  
  <meta property="og:url" content="http://anrl.github.io/JAMScript-beta/data-per/" />
  
  
  <meta property="og:image" content="" />
  
  
  <!-- Twitter summary cards -->
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@" />
  <meta name="twitter:creator" content="@" />
  <meta name="twitter:title" content="Data Persistence" />
  <meta name="twitter:description" content="Overview of Data Management In JAMScript, nodes are independent (i.e., have separate address spaces). All data processing that happens in a node are local to that node. From what we have seen so far, only way of exchanging data between nodes is to use parameter passing (i.e., message passing implemented..." />
  
  
</head>


  <body>
  
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://anrl.github.io/JAMScript-beta">JAMScript</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
          <li>
            
            





<a href="/JAMScript-beta/qstart">Quick Start</a>

          </li>
        
        
        
          <li class="navlinks-container">
            <a class="navlinks-parent" href="javascript:void(0)">Install</a>
            <div class="navlinks-children">
              
                
                  
            





<a href="/JAMScript-beta/get-src">Get Source</a>

                
              
                
                  
            





<a href="/JAMScript-beta/linux">Linux</a>

                
              
                
                  
            





<a href="/JAMScript-beta/mac">Mac</a>

                
              
                
                  
            





<a href="/JAMScript-beta/docker">Docker</a>

                
              
                
                  
            





<a href="/JAMScript-beta/iot">Embedded Computers</a>

                
              
            </div>
          </li>
        
        
        
          <li class="navlinks-container">
            <a class="navlinks-parent" href="javascript:void(0)">Run</a>
            <div class="navlinks-children">
              
                
                  
            





<a href="/JAMScript-beta/native-run">In Workstation</a>

                
              
                
                  
            





<a href="/JAMScript-beta/emulator-run">In Emulator</a>

                
              
            </div>
          </li>
        
        
        
          <li class="navlinks-container">
            <a class="navlinks-parent" href="javascript:void(0)">Language</a>
            <div class="navlinks-children">
              
                
                  
            





<a href="/JAMScript-beta/jam-overview">Overview</a>

                
              
                
                  
            





<a href="/JAMScript-beta/jam-tasks">Remote/Local Tasks</a>

                
              
                
                  
            





<a href="/JAMScript-beta/data-per">Data Persistence</a>

                
              
                
                  
            





<a href="/JAMScript-beta/flow">Flow Computing</a>

                
              
                
                  
            





<a href="/JAMScript-beta/cond-tasks">Conditional Tasks</a>

                
              
            </div>
          </li>
        
        
        
          <li class="navlinks-container">
            <a class="navlinks-parent" href="javascript:void(0)">Examples</a>
            <div class="navlinks-children">
              
                
                  
            





<a href="/JAMScript-beta/jamshell">JAMShell</a>

                
              
                
                  
            





<a href="/JAMScript-beta/parking-spot">Parking Spot App</a>

                
              
            </div>
          </li>
        
        
      </ul>
    </div>

	

  </div>
</nav>


    <!-- TODO this file has become a mess, refactor it -->





<header class="header-section ">

<div class="intro-header no-img">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-heading">
          <h1>Data Persistence</h1>
		  
		    
            <hr class="small">
            <span class="page-subheading">Logging and Broadcasting Data in JAMScript</span>
			
		  
		  
		  
        </div>
      </div>
    </div>
  </div>
</div>
</header>




<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <h2 id="overview-of-data-management">Overview of Data Management</h2>

<p>In JAMScript, nodes are independent (i.e., have separate address spaces). All
data processing that happens in a node are local to that node. From what we have
seen so far, only way of exchanging data between nodes is to use <em>parameter
passing</em> (i.e., message passing implemented via remote task invocations).</p>

<p>In edge-oriented IoT, devices can push data at high rate towards the edge for
processing. The edge computers (i.e., fogs) process the data before passing it
to the cloud. We need another mechanism besides the parameter passing to
exchange such high rate data. JAMScript introduces <strong>logger</strong> as the key
mechanism  for pushing data from the devices to the fogs and from the fogs to
the cloud.  The diagram below illustrates a simple scenario that could happen
within a single device. We have a controller and many workers in this scenario.
The workers produce the data and push it towards the controller. The logger
structure organizes the data into streams. There is one stream corresponding to
each worker. We can <strong>slice</strong> the stream at any given instance to get an array
of data for analysis.</p>

<p align="center"> <img src="/JAMScript-beta/images/lang_jdata/fig1.jpeg" width="500" /> </p>

<p>The diagram below shows a scenario where data logging happens from the device to fogs.
Still the bulk of the data is produced by workers attached to the devices. The data is funneled
through the controllers at the device towards the controller at the fog level.
The device-level controller could transform the data or add its own data stream as
the data propagates upwards.</p>

<p align="center"> <img src="/JAMScript-beta/images/lang_jdata/fig2.jpeg" width="580" /> </p>

<h2 id="logging-data">Logging Data</h2>

<p>The logger that streams the data from the worker towards the controllers at the different levels
is defined using a special <code class="highlighter-rouge">jdata</code> section in the J side of a JAMScript program as follows.</p>

<pre><code class="language-C">jdata {
    char *q as logger;
    int y as logger;
    struct location {
        float long;
        float lat;
    } loc as logger;
}
</code></pre>

<p>In the above definition, <code class="highlighter-rouge">q</code> is a string logger (i.e., stream of strings with
variable length), <code class="highlighter-rouge">y</code> is a stream of integers, and <code class="highlighter-rouge">loc</code> is stream of
structures, where each structure contains two floats. The logger is an append
only stream for the worker. That is the worker cannot read the logger. The
controllers can read the logger and obtain values at different positions of the
stream. For instance, the controller can get values by arrival time or by
position (last, first, etc) in the stream.</p>

<p>The following listings show two code segments: the J and C sides, respectively, of a JAMScript program
that is pushing data towards the controller for persistence. The controllers can apply different
types of computations (not shown) on the data. In the J side, the variable <code class="highlighter-rouge">name</code> is defined as a
string logger. Also, the J side (controller) is writing a data stream into the logger in addition to reading the
streams that are already part of the logger. The J side is writing different data values depending on its level:
cloud, fog, or device.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">jdata</span> <span class="p">{</span>
    <span class="kr">char</span> <span class="o">*</span><span class="nx">name</span> <span class="nx">as</span> <span class="nx">logger</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">nlogger</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">getMyDataStream</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">jsys</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">"cloud"</span><span class="p">)</span>
        <span class="nx">nlogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"fred@cloud-"</span> <span class="o">+</span> <span class="nx">count</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">jsys</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s2">"fog"</span><span class="p">)</span>
        <span class="nx">nlogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"fred@fog-"</span> <span class="o">+</span> <span class="nx">count</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="nx">nlogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"fred@device-"</span> <span class="o">+</span> <span class="nx">count</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">name</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">name</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"I: "</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="s2">" Name "</span><span class="p">,</span> <span class="nx">name</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">lastValue</span><span class="p">());</span>
        <span class="k">else</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Logger value undefined..."</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">count</span> <span class="o">=</span> <span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">},</span> <span class="mi">1000</span><span class="p">);</span>
</code></pre>
</div>

<p>The listing below shows the C side of the program that writes to the logger. To write to the logger, we
simply assign a value to the logger. In this case, <code class="highlighter-rouge">name</code> is assigned <code class="highlighter-rouge">buf</code> that holds the string to be
logged. If <code class="highlighter-rouge">jsleep()</code> is used to intersperse the logs, we need to put the logging actions into a local
task so that <code class="highlighter-rouge">jsleep()</code> can be used.</p>

<pre><code class="language-C">jasync logdata() {

    char *names[10] = {"david", "mayer", "justin", "richard", "lekan", "ben", "owen", "nicholas", "karu", "clark"};
    int i;
    char buf[32];

    for (i = 0; i &lt; 1000; i++) {
        sprintf(buf, "%d-%s", i, names[i % 10]);
        name = buf;
        printf("Wrote .. name: %s\n", buf);
        jsleep(1000);
    }
}

int main()
{
    logdata();
}
</code></pre>

<h2 id="data-access-scoping-in-loggers">Data Access Scoping in Loggers</h2>

<p>When declaring loggers, we can specify the level to store the data: device, fog or cloud.
Data can be written from any level at or below the one specified and can only be read to from the level specified.
This means that a <em>cloud logger</em> can be written from the device, fog or cloud levels
but can only be read from the cloud.</p>

<table>
  <thead>
    <tr>
      <th>Specifier</th>
      <th>Write Access</th>
      <th>Read Access</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Device</td>
      <td>Device</td>
      <td>Device</td>
    </tr>
    <tr>
      <td>Fog</td>
      <td>Device, Fog</td>
      <td>Fog</td>
    </tr>
    <tr>
      <td>Cloud</td>
      <td>Device, Fog, Cloud</td>
      <td>Cloud</td>
    </tr>
  </tbody>
</table>

<h2 id="broadcasting-data">Broadcasting Data</h2>

<p>While loggers push data from the workers towards controllers, broadcasters do the reverse. They are useful
for the controllers to push control data to the workers or sub controllers.
In the program shown below, two broadcasters <code class="highlighter-rouge">x</code> and <code class="highlighter-rouge">y</code> are defined. They are <em>string</em> broadcasters.
The J side is pushing different string values on <code class="highlighter-rouge">x</code> and <code class="highlighter-rouge">y</code> every 100 ms.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="nx">jdata</span> <span class="p">{</span>
    <span class="kr">char</span> <span class="o">*</span><span class="nx">x</span> <span class="nx">as</span> <span class="nx">broadcaster</span><span class="p">;</span>
    <span class="kr">char</span> <span class="o">*</span><span class="nx">y</span> <span class="nx">as</span> <span class="nx">broadcaster</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="s2">"msg-on-x="</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">count</span><span class="p">;</span>
    <span class="nx">x</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">msg2</span> <span class="o">=</span> <span class="s2">"msg-on-y="</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="nx">y</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">(</span><span class="nx">msg2</span><span class="p">);</span>
    <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
<span class="p">},</span> <span class="mi">100</span><span class="p">);</span>
</code></pre>
</div>

<p>In the C side, we define a local
task to read the incoming value. The local task waits for the value to arrive. Because the braodcaster
reception is in a local task, the main thread is still available to process other tasks.</p>

<pre><code class="language-C">jasync checkx()
{
    char *msg;
    while(1)
    {
        msg = x;
        printf("%s\n", msg);
    }
}

jasync checky()
{
    char *msg;
    while(1)
    {
        msg = y;
        printf("%s\n", msg);
    }
}

int main(int argc, char *argv[])
{
    checkx();
    checky();
}
</code></pre>

<p>We can have programs that combine braadcasting and logging because local tasks can concurrently handle both tasks. However,
any other statements in the local tasks such as reading the terminal must be non-blocking.</p>

<p>The broadcaster is written to by the controllers and read by the worker (i.e., the worker cannot write to the
broadcaster).</p>

	    
    </div>
  </div>
</div>


    <footer>
  <div class="container beautiful-jekyll-footer">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
          <li>
            <a href="https://github.com/wenger" title="GitHub">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		  
      
		  
          <li>
            <a href="mailto:robert.wenger@mail.mcgill.ca" title="Email me">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
		  
		  
		  
      
      
      
      
		  
        </ul>
        <p class="copyright text-muted">
		  Robert Wenger
		  &nbsp;&bull;&nbsp;
		  2018

		  
	    </p>
	        <!-- Please don't remove this, keep my open source work credited :) -->
		<p class="theme-by text-muted">
		  Theme by
		  <a href="http://deanattali.com/beautiful-jekyll/">beautiful-jekyll</a>
		</p>
      </div>
    </div>
  </div>
</footer>

  
    






  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script>
      	if (typeof jQuery == 'undefined') {
      	  document.write('<script src="/JAMScript-beta/js/jquery-1.11.2.min.js"></scr' + 'ipt>');
      	}
      </script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
	<script src="/JAMScript-beta/js/bootstrap.min.js"></script>
    
  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
	<script src="/JAMScript-beta/js/main.js"></script>
    
  




  
  </body>
</html>
